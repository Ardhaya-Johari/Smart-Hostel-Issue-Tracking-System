generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(STUDENT)
  name      String
  hostel    String?
  block     String?
  room      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reportedIssues        Issue[]        @relation("ReporterRelation")
  assignedIssues        Issue[]        @relation("AssigneeRelation")
  reportedLostAndFounds LostAndFound[] @relation("LAFReporter")
  claimedLostAndFounds  LostAndFound[] @relation("LAFClaimant")
  comments              Comment[]
  announcements         Announcement[] @relation("AnnouncementCreator")

  @@map("users")
}

model Issue {
  id          String     @id @default(cuid())
  title       String
  description String
  category    Category
  priority    Priority
  visibility  Visibility @default(PUBLIC)
  status      Status     @default(REPORTED)
  hostel      String
  block       String
  room        String
  reporterId  String
  assigneeId  String?
  mediaUrls   String[] // Array of Cloudinary URLs
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  reporter      User                 @relation("ReporterRelation", fields: [reporterId], references: [id])
  assignee      User?                @relation("AssigneeRelation", fields: [assigneeId], references: [id])
  statusHistory IssueStatusHistory[]
  comments      Comment[]
  mergedInto    Issue?               @relation("IssueMerges", fields: [mergedIntoId], references: [id])
  mergedIssues  Issue[]              @relation("IssueMerges")
  mergedIntoId  String?

  @@index([hostel, block, category])
  @@map("issues")
}

model LostAndFound {
  id          String          @id @default(cuid())
  itemName    String
  description String
  location    String
  date        DateTime
  status      LostFoundStatus @default(OPEN)
  mediaUrls   String[]
  reporterId  String
  claimantId  String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  reporter User? @relation("LAFReporter", fields: [reporterId], references: [id])
  claimant User? @relation("LAFClaimant", fields: [claimantId], references: [id])

  @@map("lost_and_found")
}

model IssueStatusHistory {
  id        String   @id @default(cuid())
  issueId   String
  status    Status
  changedBy String
  timestamp DateTime @default(now())

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@map("issue_status_history")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  issueId   String
  authorId  String
  parentId  String? // For threaded replies
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  issue   Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author  User      @relation(fields: [authorId], references: [id])
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies Comment[] @relation("CommentReplies")

  @@map("comments")
}

model Announcement {
  id           String   @id @default(cuid())
  title        String
  content      String
  targetHostel String?
  targetBlock  String?
  targetRole   Role?
  creatorId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  creator User @relation("AnnouncementCreator", fields: [creatorId], references: [id])

  @@map("announcements")
}

enum Role {
  STUDENT
  ADMIN
}

enum Category {
  PLUMBING
  ELECTRICAL
  INTERNET
  CLEANLINESS
  FURNITURE
  OTHER
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  EMERGENCY
}

enum Visibility {
  PUBLIC
  PRIVATE
}

enum Status {
  REPORTED
  ASSIGNED
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum LostFoundStatus {
  OPEN
  CLAIMED
}
